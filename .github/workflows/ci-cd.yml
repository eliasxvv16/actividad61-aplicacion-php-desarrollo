name: CI/CD Wuthering Waves CRUD

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Paso 1: Descargar el cÃ³digo del repositorio
    - name: ğŸ“¦ Checkout cÃ³digo
      uses: actions/checkout@v3

    # Paso 2: Iniciar sesiÃ³n en DockerHub
    - name: ğŸ” Login a DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # Paso 3: Construir la imagen Docker (BUILD)
    - name: ğŸ—ï¸ Build imagen Docker
      run: |
        docker build -t eliasxvv16/actividad61-aplicacion-crud-php:latest .

    # Paso 4: Subir imagen a DockerHub (PUSH)
    - name: ğŸ“¤ Push imagen a DockerHub
      run: |
        docker push eliasxvv16/actividad61-aplicacion-crud-php:latest

    # Paso 5: Conectar por SSH a producciÃ³n y desplegar (PULL & RUN)
    - name: ğŸš€ Desplegar en producciÃ³n vÃ­a SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/actividad61-aplicacion-php-produccion
          docker-compose pull
          docker-compose up -d
          docker image prune -f